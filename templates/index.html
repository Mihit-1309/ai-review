<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Product Review Summary</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        html, body {
            height: 100%;
        }

        body {
            font-family: Arial, Helvetica, sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
        }


        .container {
            width: 100%;
            height: 100vh;
            margin: 0;
            background: white;
            padding: 24px 40px;
            box-sizing: border-box;
        }

        h1 {
            margin-bottom: 10px;
        }

        .subtitle {
            color: #555;
            margin-bottom: 25px;
        }

        textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            font-size: 15px;
            border-radius: 8px;
            border: 1px solid #ccc;
            resize: vertical;
        }

        button {
            margin-top: 20px;
            padding: 12px 25px;
            font-size: 16px;
            background-color: #2563eb;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        button:hover {
            background-color: #1e40af;
        }

        .output {
            margin-top: 30px;
            padding: 20px;
            background: #f9fafb;
            border-left: 5px solid #2563eb;
            border-radius: 8px;
            display: none;
        }

        .output h3 {
            margin-top: 0;
        }

        .loader {
            position: absolute;
            top: 120px;
            left: 0;
            width: 100%;
            text-align: center;
            background: rgba(255,255,255,0.8);
            padding: 10px;
            display: none;
            z-index: 999;
        }


        footer {
            margin-top: 40px;
            text-align: center;
            font-size: 13px;
            color: #777;
        }
        .active-topic {
           background-color: #00030b;
        }
        .topic-link {
            color: #151515;
            cursor: pointer;
            padding: 3px 6px;
        }
        .topic-link:hover {
            text-decoration: underline;
        }

        #topicBox, #topicList, .topic-link {
            background: none; /* highlight click area */
        }

        #reviewsContent ul {
            padding-left: 20px;
        }

        #reviewsContent li {
            padding: 8px;
            background: #f1f5f9;
            border-radius: 8px;
        }

        /* ================= CHATBOT UI ================= */

        .chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 260px); /* adjusts for header & inputs */
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            background: #fafafa;
        }

        .chat-messages {
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }


        .chat-input {
            display: flex !important;
            align-items: center !important;
            gap: 12px;
            padding: 10px 14px;
            border-top: 1px solid #e5e7eb;
            background: white;
        }

        .chat-input textarea {
            flex: 1;
            height: 40px !important;
            min-height: 40px !important;
            max-height: 120px;
            resize: none;
            padding: 8px 12px;
            font-size: 14px;
            line-height: 1.4;
            border-radius: 10px;
            box-sizing: border-box;
            display: block;
        }


        .message {
            max-width: 65%;
            padding: 12px 16px;
            border-radius: 14px;
            margin-bottom: 12px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .message.user {
            background: #2563eb;
            color: white;
            align-self: flex-end;
            text-align: left;
            border-bottom-right-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .message.bot {
            background: #e5e7eb;
            color: #111;
            align-self: flex-start;
            text-align: left;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        }


        .sources {
            margin-top: 8px;
            font-size: 13px;
            background: #f9fafb;
            padding: 8px;
            border-radius: 6px;
        }
        #chatInput {
            flex: 1;
            resize: none;
            height: 40px;
            min-height: 40px;
            max-height: 120px;          /* üî• max growth (3 lines approx) */
            padding: 8px 12px;
            font-size: 14px;
            line-height: 1.4;
            border-radius: 10px;
            box-sizing: border-box;
            overflow-y: hidden;         /* no scrollbar until max */
        }

        #sendBtn {
            height: 40px;
            padding: 0 18px;
            font-size: 14px;
            border-radius: 10px;
            background: #2563eb;
            color: white;
            border: none;
            cursor: pointer;
            white-space: nowrap;
        }

        #sendBtn:hover {
            background: #1e40af;
        }

        .chat-input button {
            margin-top: 0 !important;   /* üî• THIS FIXES IT */
            height: 40px;
            padding: 0 18px;
            font-size: 14px;
            border-radius: 10px;
            background: #2563eb;
            color: white;
            border: none;
            cursor: pointer;
            white-space: nowrap;
        }

        /* ===== Review list inside chatbot ===== */

       .review-item {
            display: inline-block;
            width: 100%;
            padding: 8px 10px;
            margin-bottom: 6px;
            background: #f1f5f9;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.4;
        }

        .review-item:last-child {
            margin-bottom: 0;
        }

        .review-item * {
            margin: 0 !important;
            padding: 0;
        }

        .review-rating {
            font-weight: 600;
            margin-bottom: 2px !important;
        }

        .review-text {
            line-height: 1.4;
        }
        .review-container {
            margin: 6px 0 12px 0;
            padding: 8px 10px;
            background: #f9fafb;
            border-radius: 6px;
            font-size: 13px;
        }
        /* Small inline button (used for Show/Hide reviews) */
        .review-toggle-btn {
            margin-top: 6px;
            padding: 6px 14px;
            font-size: 13px;
            border-radius: 10px;
            background: #2563eb;
            color: white;
            border: none;
            cursor: pointer;
            width: auto;          /* üî• NOT full width */
            display: inline-block;
            align-self: flex-start; 
        }

        .review-toggle-btn:hover {
            background: #1e40af;
        }

    </style>
</head>

<body>

<div class="container">

    <!-- TAB BUTTONS -->
    <button onclick="showTab('summaryTab')">Summary</button>
    <button onclick="showTab('addReviewTab')">Add Review</button>
    <button onclick="showTab('chatTab')">Chatbot</button>
    <!-- ================= SUMMARY TAB ================= -->
    <div id="summaryTab" style="display:block;">

        <h1>Customer Review Summary</h1>
        <p class="subtitle"><strong>‚ÄúCustomers say‚Äù</strong> summary based on product reviews</p>

        <textarea id="questionInput" placeholder="Ask about customer opinions..."></textarea>

        <div>Store ID:</div>
        <input id="wsid" placeholder="Enter Store ID" /><br><br>

        <div>Product ID:</div>
        <input id="productId" placeholder="Enter Product ID" /><br>

        <button onclick="generateSummary('neutral')">Generate Summary</button>
        <button onclick="generateSummary('positive')">Positive AI Summary</button>
        <button onclick="generateSummary('negative')">Negative AI Summary</button>
        <button onclick="generateTopics()">Generate Top Topics</button>

        <div class="output" id="topicBox">
            <h3>Top Topics</h3>
            <ul id="topicList"></ul>
        </div>
        <div class="output" id="reviewsBox" style="display:none;">
         <h3>Reviews for selected topic</h3>
         <div id="reviewsContent"></div>
        </div>

        <div class="loader" id="loader">Generating summary...</div>

        <div class="output" id="summaryBox" style="display:none;">
            <h3>Customers say</h3>
            <div id="topicButtons"></div>
            <div id="topicSummary" style="display:none;">
                <p id="summaryText"></p>
            </div>
        </div>

        <div class="output" id="wordsBox" style="display:none;">
            <h3>Top discussed words</h3>
            <ul id="wordsList"></ul>
        </div>

    </div>

    <!-- ================= ADD REVIEW TAB ================= -->
    <div id="addReviewTab" style="display:none;">

        <h1>Add Review</h1>
        <p class="subtitle">Insert new customer reviews into MongoDB</p>

        <div>Store ID:</div>
        <input id="new_wsid" placeholder="Store ID" /><br><br>

        <div>Product ID:</div>
        <input id="new_productId" placeholder="Product ID" /><br><br>
        <div>Product Name:</div>
        <input id="product_name" placeholder="Product Name" /><br><br>

        <div>Rating:</div>
        <input id="rating" type="number" min="1" max="5" placeholder="1-5" /><br><br>


        <div>Review text:</div>
        <textarea id="newReviewText" placeholder="Write customer review..."></textarea><br>

        <button onclick="submitReview()">Submit Review</button>

        <div id="reviewStatus" style="margin-top:10px;color:green;"></div>
    </div>

    <!-- ================= CHATBOT TAB ================= -->
    <div id="chatTab" style="display:none;">

        <h1>Review Chatbot</h1>
        <p class="subtitle">
            Ask questions and get answers grounded in customer reviews
        </p>

        <div>Store ID:</div>
        <input id="chat_wsid" placeholder="Enter Store ID" /><br><br>

        <div>Product ID:</div>
        <input id="chat_productId" placeholder="Enter Product ID" /><br>

        <div class="chat-container">
            <div id="chatMessages" class="chat-messages"></div>

            <div class="chat-input">
                <textarea
                    id="chatInput"
                    rows = "1"
                    placeholder="Ask something like: What do customers say about battery life?"
                ></textarea>
                <button id="sendBtn" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>



</div>


<script>
    let topicData = [];
// Clear session every time page loads
window.addEventListener("load", function() {
    fetch("/reset-session", { method: "POST" });
});

function showTab(tab) {
    document.getElementById("summaryTab").style.display = "none";
    document.getElementById("addReviewTab").style.display = "none";
    document.getElementById("chatTab").style.display = "none";
    document.getElementById(tab).style.display = "block";
}

// ===============================
// CHAT INPUT CONTROLS (Enter to send)
// ===============================

const chatInput = document.getElementById("chatInput");

if (chatInput) {

    // üîπ Auto resize textarea
    chatInput.addEventListener("input", () => {
        chatInput.style.height = "40px";
        const newHeight = Math.min(chatInput.scrollHeight, 120);
        chatInput.style.height = newHeight + "px";
    });

    // üîπ Enter to Send | Shift+Enter for new line
    chatInput.addEventListener("keydown", function (event) {

        if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault();  // stop new line
            sendMessage();           // send message
        }

    });
}

async function submitReview() {
    const wsid = document.getElementById("new_wsid").value.trim();
    const productId = document.getElementById("new_productId").value.trim();
    const reviewText = document.getElementById("newReviewText").value.trim();

    if (!wsid || !productId || !reviewText) {
        alert("Store ID, Product ID and Review are required!");
        return;
    }

    const rating = Number(document.getElementById("rating").value);

    if (!rating || rating < 1 || rating > 5) {
    alert("Rating must be between 1 and 5");
    return;
    }


    const body = {
        review_id: generateUUID(),
        wsid: wsid,
        product_id: productId,
        product_name: document.getElementById("product_name").value,
        rating: Number(document.getElementById("rating").value),
        review_text: reviewText,
        embedded: false
    };

    try {
        const res = await fetch("/reviews", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });

        const data = await res.json();

        if (res.ok) {
            document.getElementById("reviewStatus").innerText =
                "Review submitted successfully!";
            document.getElementById("newReviewText").value = "";
        } else {
            alert("Error: " + (data.error || "Unknown Error"));
        }

    } catch (err) {
        console.error(err);
        alert("Failed to connect to server");
    }
}



function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}





async function generateSummary(type) {
    const question = document.getElementById("questionInput").value.trim();
    const summaryBox = document.getElementById("summaryBox");
    const summaryText = document.getElementById("summaryText");
    const loader = document.getElementById("loader");


    
    if (type !== "neutral" && !question) {
        alert("Please enter a question for this summary type.");
        return;
    }

    loader.style.display = "block";
    summaryBox.style.display = "none";

    try {
        const response = await fetch("/ask", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                question: question,
                wsid: document.getElementById("wsid").value,
                product_id: document.getElementById("productId").value,
                summary_type: type
            })
        });

        const data = await response.json();

        // üîπ Neutral summary
        // Neutral summary
        if (type === "neutral") {
            document.getElementById("topicButtons").innerHTML = "";

            summaryText.innerText =
                data.answer || "No summary available.";

            document.getElementById("topicSummary").style.display = "block";
            document.getElementById("summaryBox").style.display = "block";

            return;
        }


        // üîπ Positive / Negative topic-wise
        topicData = data.topics || [];

        const buttonsContainer = document.getElementById("topicButtons");
        buttonsContainer.innerHTML = "";
        summaryText.innerText = "";
        document.getElementById("topicSummary").style.display = "none";

        topicData.forEach((item, index) => {
            const btn = document.createElement("button");
            btn.innerText = item.topic;

            btn.onclick = () => {
                document
                  .querySelectorAll("#topicButtons button")
                  .forEach(b => b.classList.remove("active-topic"));

                btn.classList.add("active-topic");
                showTopicSummary(index);
            };
            buttonsContainer.appendChild(btn);
        });

        summaryBox.style.display = "block";

    } catch (error) {
        alert("Failed to generate summary.");
        console.error(error);
    } finally {
        loader.style.display = "none";
    }
}




function showTopicSummary(index) {
    document.getElementById("summaryText").innerText =
        topicData[index].summary;

    document.getElementById("topicSummary").style.display = "block";
}

// -----------------


async function generateTopics() {
    const wsid = document.getElementById("wsid").value.trim();
    const productId = document.getElementById("productId").value.trim();

    if (!wsid || !productId) {
        alert("Please enter Store ID and Product ID");
        return;
    }

    const topicBox = document.getElementById("topicBox");
    const list = document.getElementById("topicList");
    const loader = document.getElementById("loader");

    list.innerHTML = "";
    topicBox.style.display = "none";
    loader.style.display = "block";

    try {
        const res = await fetch("/topics/top", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                WSID: wsid,
                product_id: productId
            })
        });

        const data = await res.json();

        if (!res.ok) {
            alert(data.error || "Failed to fetch topics");
            return;
        }

        if (!data.topics || data.topics.length === 0) {
            list.innerHTML = "<li>No topics found</li>";
        } else {
            data.topics.forEach(t => {
            const li = document.createElement("li");

            const span = document.createElement("span");
            span.className = "topic-link";
            span.dataset.topic = t.topic;
            span.innerText = `${t.topic} (${t.count})`;
            span.style.textTransform = "capitalize";

            span.style.cursor = "pointer";

            span.onclick = () => {
                console.log("CLICKED TOPIC:", t.topic);
                fetchReviewsByTopic(t.topic);
            };

            li.appendChild(span);
            list.appendChild(li);
        });



        }



    } catch (err) {
        console.error(err);
        alert("Server error while fetching topics");
    } finally {
        loader.style.display = "none";
        topicBox.style.display = "block";
    }
}
async function fetchReviewsByTopic(topic) {
    console.log("Fetching reviews for:", topic);

    const wsid = document.getElementById("wsid").value.trim();
    const productId = document.getElementById("productId").value.trim();

    if (!wsid || !productId) {
        alert("Store ID and Product ID required!");
        return;
    }

    const res = await fetch(`/api/reviews-by-topic?topic=${encodeURIComponent(topic)}&wsid=${encodeURIComponent(wsid)}&product_id=${encodeURIComponent(productId)}`);
    console.log("API URL:", res);
    const data = await res.json();
    console.log("API RESPONSE:", data);
    const box = document.getElementById("reviewsBox");
    const content = document.getElementById("reviewsContent");

    if (!data.reviews || data.reviews.length === 0) {
        content.innerHTML = `<p>No reviews found for topic: <b>${topic}</b></p>`;
        box.style.display = "block";
        return;
    }

    let html = `<p><b>Topic:</b> ${topic}</p><ul>`;
    data.reviews.forEach(r => {
        html += `
            <li style="margin-bottom:10px;">
                <b>Rating:</b> ${r.rating}<br>
                <b>Review:</b> ${r.review_text}
            </li>
        `;
    });
    html += `</ul>`;

    content.innerHTML = html;
    box.style.display = "block";
}

async function sendMessage() {
    const input = document.getElementById("chatInput");
    const messages = document.getElementById("chatMessages");

    const question = input.value.trim();
    const wsid = document.getElementById("chat_wsid").value.trim();
    const productId = document.getElementById("chat_productId").value.trim();

    console.log("CHAT wsid:", wsid);
    console.log("CHAT product_id:", productId);
    console.log("CHAT question:", question);

    if (!wsid || !productId) {
        alert("Please enter Store ID and Product ID");
        return;
    }

    if (!question) return;

    // User bubble
    const userDiv = document.createElement("div");
    userDiv.className = "message user";
    userDiv.innerText = question;
    messages.appendChild(userDiv);

    input.value = "";
    messages.scrollTop = messages.scrollHeight;

    // Typing indicator
    const typingDiv = document.createElement("div");
    typingDiv.className = "message bot";
    typingDiv.innerText = "Typing...";
    messages.appendChild(typingDiv);

    try {
        const response = await fetch("/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                wsid: wsid,
                product_id: productId,
                question: question
            })
        });

        const data = await response.json();
        typingDiv.remove();

        const botDiv = document.createElement("div");
        botDiv.className = "message bot";

        /* Answer text */
        const answerDiv = document.createElement("div");
        answerDiv.innerText = data.answer || "No answer found.";
        botDiv.appendChild(answerDiv);
        
        messages.appendChild(botDiv);

        /* ===== Reviews OUTSIDE the bot bubble ===== */
        if (data.reviews && data.reviews.length > 0) {

            const btn = document.createElement("button");
            btn.innerText = "Show reviews";
            btn.className = "review-toggle-btn";

            const reviewsDiv = document.createElement("div");
            reviewsDiv.className = "review-container";
            reviewsDiv.style.display = "none";

            let html = "<strong>Reviews used:</strong>";

            data.reviews.forEach(r => {
                html += `
                    <div class="review-item">
                        <div class="review-rating">Rating: ${r.rating ?? "N/A"}</div>
                        <div class="review-text">${r.review_text}</div>
                    </div>
                `;
            });

            reviewsDiv.innerHTML = html;

            btn.onclick = () => {
                const show = reviewsDiv.style.display === "none";
                reviewsDiv.style.display = show ? "block" : "none";
                btn.innerText = show ? "Hide reviews" : "Show reviews";
            };

            messages.appendChild(btn);
            messages.appendChild(reviewsDiv);
        }


        messages.scrollTop = messages.scrollHeight;

        messages.scrollTop = messages.scrollHeight;

    } catch (err) {
        typingDiv.innerText = "Error getting response.";
        console.error(err);
    }

// const chatInput = document.getElementById("chatInput");

// if (chatInput) {
//     chatInput.addEventListener("input", () => {
//         // reset height so it can shrink if needed
//         chatInput.style.height = "40px";

//         // grow up to max height
//         const newHeight = Math.min(chatInput.scrollHeight, 120);
//         chatInput.style.height = newHeight + "px";
//     });
// }

}


</script>




</body>
</html>
